<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="icons/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#006400" />
    <title>TreeScroller</title>
    <style>
      body,
      html {
        width: 100vw;
        height: 100vh;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      #main-canvas {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <canvas id="main-canvas"></canvas>

    <script>
      // Canvas setup
      const canvas = document.querySelector("#main-canvas");
      const ctx = canvas.getContext("2d");
      const pixelRatio = window.devicePixelRatio;
      ctx.imageSmoothingQuality = "high";
      ctx.canvas.width = canvas.clientWidth * pixelRatio;
      ctx.canvas.height = canvas.clientHeight * pixelRatio;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(pixelRatio, pixelRatio);

      // State
      let mouseDown = false;

      let numLeaves = 10;
      let leaves = [];
      let touchStart = -1;

      const startHandler = (clientY) => {
        touchStart = clientY;
      };

      const moveHandler = (clientY) => {
        if (clientY < touchStart) {
          numLeaves *= 1.1;
        } else {
          numLeaves *= 0.9;
        }
        leaves = [];
        calculateLeaves();
      };

      // Events
      document.addEventListener("mousedown", (event) => {
        startHandler(event.clientY);
        mouseDown = true;
        event.preventDefault();
        event.stopPropagation();
      });
      document.addEventListener("mouseup", (event) => {
        mouseDown = false;
        event.preventDefault();
        event.stopPropagation();
      });
      document.addEventListener("mousemove", (event) => {
        if (mouseDown) {
          moveHandler(event.clientY);
        }
        event.preventDefault();
        event.stopPropagation();
      });
      document.addEventListener("touchstart", (event) => {
        startHandler(event.touches[0].clientY);
        event.preventDefault();
        event.stopPropagation();
      });
      document.addEventListener("touchmove", (event) => {
        moveHandler(event.touches[0].clientY);
        event.preventDefault();
        event.stopPropagation();
      });

      // Drawing

      const screenW = ctx.canvas.width;
      const screenH = ctx.canvas.height;
      const canvasW = screenW / pixelRatio;
      const canvasH = screenH / pixelRatio;
      const centerX = canvasW / 2;
      const centerY = canvasH / 2;

      const treeWidth = 50;
      const treeHeight = 200;

      // Draw the trunk
      const drawTrunk = () => {
        ctx.fillStyle = "brown";
        ctx.fillRect(
          centerX - treeWidth / 2,
          canvasH - treeHeight,
          treeWidth,
          treeHeight
        );
      };

      const rand = (min, max) =>
        Math.floor(Math.random() * (max - min + 1)) + min;

      const calculateLeaves = () => {
        const leavesDiameter = (canvasW / 4) * 3;
        const startX = canvasW - leavesDiameter;
        const endX = leavesDiameter;
        const startY = canvasH - treeHeight - leavesDiameter;
        const endY = canvasH - treeHeight;

        for (let i = 0; i < numLeaves; i++) {
          const x = rand(startX, endX);
          const y = rand(startY, endY);
          const radius = rand(10, 30);

          leaves.push({ x, y, radius });
        }
      };

      calculateLeaves();

      // Draw the leaves
      const drawLeaves = () => {
        ctx.fillStyle = "darkgreen";
        leaves.forEach((leaf) => {
          ctx.beginPath();
          ctx.arc(leaf.x, leaf.y, leaf.radius, 0, Math.PI * 2);
          ctx.fill();
        });
      };

      // Draw the tree
      const drawTree = () => {
        drawTrunk();
        drawLeaves();
      };

      // Loop
      const loop = () => {
        ctx.clearRect(0, 0, screenW, screenH);

        // Background

        ctx.fillStyle = "#99ff99";
        ctx.fillRect(0, 0, screenW, screenH);

        drawTree();

        requestAnimationFrame(loop);
      };

      requestAnimationFrame(loop);
    </script>
  </body>
</html>
